{% extends 'base_dashboard.html.twig' %}

{% block title %}Réservations{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Liste des Réservations</h1>
            <a href="{{ path('app_admin_reservations_new') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nouvelle Réservation
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher une réservation...">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Véhicule</th>
                                <th>Date de Réservation</th>
                                <th>État</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTableBody">
                            {% for reservation in reservations %}
                                <tr>
                                    <td>{{ reservation.nameRes }}</td>
                                    <td>{{ reservation.car.marque }} - {{ reservation.car.immatriculation }}</td>
                                    <td>{{ reservation.dateRes|date('d/m/Y') }}</td>
                                    <td>
                                        <span class="badge bg-{{ reservation.statut == 'confirmé' ? 'success' : (reservation.statut == 'annulé' ? 'danger' : 'warning') }}">
                                            {{ reservation.statut }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{{ path('app_reservations_show', {'idRes': reservation.idRes}) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ path('app_reservations_edit', {'idRes': reservation.idRes}) }}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ path('app_reservations_pdf', {'idRes': reservation.idRes}) }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                        <form method="post" action="{{ path('app_reservations_delete', {'idRes': reservation.idRes}) }}" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette réservation ?');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reservation.idRes) }}">
                                            <button class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">Aucune réservation trouvée</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% block javascripts %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const searchInput = document.getElementById('searchInput');
                const searchButton = document.getElementById('searchButton');
                const tableBody = document.getElementById('reservationsTableBody');
                let searchTimeout;

                function performSearch() {
                    const searchTerm = searchInput.value.trim();
                    console.log('Searching for:', searchTerm);
                    
                    fetch(`/admin/reservations/search?q=${encodeURIComponent(searchTerm)}`)
                        .then(response => {
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Received data:', data);
                            tableBody.innerHTML = '';
                            
                            if (data.error) {
                                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">' + data.error + '</td></tr>';
                                return;
                            }
                            
                            if (data.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Aucune réservation trouvée</td></tr>';
                                return;
                            }

                            data.forEach(reservation => {
                                console.log('Processing reservation:', reservation);
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${reservation.nameRes || 'N/A'}</td>
                                    <td>${reservation.car ? reservation.car.marque + ' - ' + reservation.car.immatriculation : 'N/A'}</td>
                                    <td>${reservation.dateRes ? new Date(reservation.dateRes).toLocaleDateString() : 'N/A'}</td>
                                    <td>
                                        <span class="badge bg-${reservation.statut === 'confirmé' ? 'success' : (reservation.statut === 'annulé' ? 'danger' : 'warning')}">
                                            ${reservation.statut || 'N/A'}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="/admin/reservations/${reservation.idRes}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/admin/reservations/${reservation.idRes}/edit" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="/admin/reservations/${reservation.idRes}/pdf" class="btn btn-sm btn-success">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                        <form method="post" action="/admin/reservations/${reservation.idRes}/delete" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette réservation ?');">
                                            <button class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                `;
                                tableBody.appendChild(row);
                            });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Une erreur est survenue lors de la recherche</td></tr>';
                        });
                }

                // Debounce the search to avoid too many requests
                function debounceSearch() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(performSearch, 300); // Wait 300ms after last keypress
                }

                searchInput.addEventListener('input', debounceSearch);
                searchButton.addEventListener('click', performSearch);
            });
        </script>
    {% endblock %}
{% endblock %} 